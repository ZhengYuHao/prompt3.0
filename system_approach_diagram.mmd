graph TB
    %% ç§‘ç ”è§†è§’çš„ç³»ç»Ÿæ¶æ„å›¾
    %% è®¾è®¡åŸåˆ™ï¼šæçª„åŒ–LLM - è§„åˆ™å¼•æ“ä¼˜å…ˆï¼ŒLLMå…œåº•

    subgraph Input[è¾“å…¥å±‚]
        User_Input[ç”¨æˆ·è¾“å…¥<br/>è‡ªç„¶è¯­è¨€éœ€æ±‚]
    end

    subgraph Prompt10[Prompt 1.0: æ–‡æœ¬é¢„å¤„ç†å±‚]
        direction TB
        subgraph Standardization[æ–‡æœ¬æ ‡å‡†åŒ–]
            Rule_Norm[è§„åˆ™å¼•æ“<br/>RuleBasedTextNormalizer<br/>å£è¯­æ°”è¯/å£è¯­/æ ‡ç‚¹è§„èŒƒåŒ–]
            LLM_Std[LLMæ ‡å‡†åŒ–<br/>è§„åˆ™å¤±è´¥æ—¶å›é€€]
        end

        subgraph Ambiguity[æ­§ä¹‰æ£€æµ‹]
            Rule_Amb[è§„åˆ™å¼•æ“<br/>SyntacticAmbiguityDetector<br/>å¥æ³•æ¨¡å¼è¯†åˆ«]
            LLM_Amb[LLMæ·±åº¦æ£€æŸ¥<br/>è§„åˆ™å¤±è´¥æ—¶å›é€€]
        end

        Clean_Text[æ ‡å‡†åŒ–æ–‡æœ¬]
    end

    subgraph Prompt20[Prompt 2.0: å®ä½“æå–å±‚]
        direction TB
        subgraph EntityExtraction[å®ä½“æå–]
            Regex_Ext[æ­£åˆ™æå–å™¨<br/>PrePatternExtractor<br/>æ•°å­—+å•ä½/æŠ€æœ¯æ ˆæ¨¡å¼]
            LLM_Ext[LLMå®ä½“æå–<br/>æ­£åˆ™ä¸è¶³æ—¶è¡¥å……]
        end

        Merge[ç»“æœåˆå¹¶<br/>æ­£åˆ™ä¼˜å…ˆ]

        subgraph ConflictResolution[å†²çªè§£å†³]
            Overlap[ä½ç½®é‡å è§£å†³<br/>æœ€é•¿è¦†ç›–åŸåˆ™]
            Dedup[å˜é‡åå»é‡<br/>è‡ªåŠ¨ç¼–å·]
        end

        Variable_Registry[å˜é‡æ³¨å†Œè¡¨<br/>{{variable_name}}]
    end

    subgraph Prompt30[Prompt 3.0: DSLè½¬è¯‘å±‚]
        direction TB
        Template[æ¨¡æ¿ç”Ÿæˆ<br/>å°†å˜é‡æ’å…¥å ä½ç¬¦]
        LLM_Transpile[LLMè½¬è¯‘<br/>ç”ŸæˆDSLé€»è¾‘]

        subgraph DSLCompiler[DSLç¼–è¯‘å™¨]
            Validate[éªŒè¯å™¨<br/>è¯­æ³•/ç±»å‹æ£€æŸ¥]
            Fix[è‡ªåŠ¨ä¿®å¤å™¨<br/>é”™è¯¯ä¿®å¤]
        end

        DSL_Code[DSLä»£ç <br/>DEFINE/CALL/IF/FOR]
    end

    subgraph Output[è¾“å‡ºå±‚]
        Generated_Code[ç”Ÿæˆçš„ä»£ç <br/>å¯æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘]
    end

    %% ä¼˜åŒ–æ¨¡å—ï¼ˆç»¿è‰²ï¼‰
    subgraph Optimizations[ä¼˜åŒ–æ¨¡å—å±‚<br/>ğŸŸ¢ å·²é›†æˆ | ğŸ”´ æœªé›†æˆ]
        Opt1[ä¼˜åŒ–ç‚¹1: è§„åˆ™å¼•æ“<br/>ğŸŸ¢ å·²é›†æˆ<br/>60-80%ä»»åŠ¡ç”±è§„åˆ™å¤„ç†]
        Opt2[ä¼˜åŒ–ç‚¹2: æ­£åˆ™æå–å™¨<br/>ğŸŸ¢ å·²é›†æˆ<br/>40-70%å®ä½“ç”±æ­£åˆ™æå–]
        Opt3[ä¼˜åŒ–ç‚¹3: DSLæ„å»ºå™¨<br/>ğŸ”´ æœªé›†æˆ<br/>ä»£ç ä¸»å¯¼ï¼ŒLLMè¾…åŠ©]
        Opt4[ä¼˜åŒ–ç‚¹4: å¢å¼ºéªŒè¯å™¨<br/>ğŸ”´ æœªé›†æˆ<br/>æ‰©å±•éªŒè¯è§„åˆ™]
        Opt5[ä¼˜åŒ–ç‚¹5: ç¼“å­˜æœºåˆ¶<br/>ğŸ”´ æœªé›†æˆ<br/>é¿å…é‡å¤LLMè°ƒç”¨]
        Opt6[ä¼˜åŒ–ç‚¹6: å¢å¼ºä¿®å¤å™¨<br/>ğŸ”´ æœªé›†æˆ<br/>æ‰©å±•ä¿®å¤è§„åˆ™]
    end

    %% æ•°æ®æµï¼ˆè“è‰²ç®­å¤´ï¼‰
    User_Input -->|1. åŸå§‹æ–‡æœ¬| Standardization
    Rule_Norm -->|è§„åˆ™æˆåŠŸ| Clean_Text
    Rule_Norm -.->|è§„åˆ™å¤±è´¥| LLM_Std
    LLM_Std -->|å›é€€ç»“æœ| Clean_Text

    Clean_Text -->|2. æ ‡å‡†åŒ–æ–‡æœ¬| Ambiguity
    Rule_Amb -->|æ£€æµ‹åˆ°æ­§ä¹‰| Clean_Text
    Rule_Amb -.->|æœªæ£€æµ‹åˆ°| LLM_Amb
    LLM_Amb -.->|æ·±åº¦æ£€æŸ¥| Clean_Text

    Clean_Text -->|3. æ¸…æ´—æ–‡æœ¬| EntityExtraction
    Regex_Ext -->|æå–ç»“æœ| Merge
    Regex_Ext -.->|æå–ä¸è¶³| LLM_Ext
    LLM_Ext -->|è¡¥å……ç»“æœ| Merge

    Merge -->|4. åˆå¹¶å®ä½“| ConflictResolution
    Overlap -->|ä½ç½®è¿‡æ»¤| Dedup
    Dedup -->|å»é‡å®ä½“| Variable_Registry

    Variable_Registry -->|5. å˜é‡åˆ—è¡¨| Template
    Template -->|6. æ¨¡æ¿| LLM_Transpile
    LLM_Transpile -->|7. åŸå§‹DSL| DSLCompiler
    Validate -->|8. éªŒè¯é€šè¿‡| Fix
    Validate -.->|éªŒè¯å¤±è´¥| Fix
    Fix -->|9. ä¿®å¤å| DSL_Code

    DSL_Code -->|10. å¯æ‰§è¡ŒDSL| Output

    %% ä¼˜åŒ–å…³ç³»ï¼ˆç»¿è‰²è™šçº¿ï¼‰
    Opt1 -.->|æ›¿ä»£éƒ¨åˆ†LLMè°ƒç”¨| Standardization
    Opt2 -.->|æ›¿ä»£éƒ¨åˆ†LLMè°ƒç”¨| EntityExtraction
    Opt3 -.->|ä¼˜åŒ–DSLç”Ÿæˆ| Prompt30
    Opt4 -.->|å¢å¼ºéªŒè¯| DSLCompiler
    Opt5 -.->|ç¼“å­˜LLMå“åº”| LLM_Transpile
    Opt6 -.->|å¢å¼ºä¿®å¤| Fix

    %% æ ·å¼å®šä¹‰
    classDef input fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef output fill:#c8e6c9,stroke:#6a1b9a,stroke-width:3px
    classDef process fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef optimization fill:#e8f5e9,stroke:#880e4f,stroke-width:2px,stroke-dasharray: 5 5
    classDef llm fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef rule fill:#e8f5e9,stroke:#880e4f,stroke-width:2px
    classDef success fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    classDef pending fill:#fff9c4,stroke:#f57f17,stroke-width:2px

    %% åº”ç”¨æ ·å¼
    class User_Input input
    class Generated_Code output
    class Standardization,Ambiguity,EntityExtraction,ConflictResolution,Template,DSLCompiler process
    class Opt1,Opt2,Opt3,Opt4,Opt5,Opt6 optimization
    class LLM_Std,LLM_Amb,LLM_Ext,LLM_Transpile llm
    class Rule_Norm,Rule_Amb,Regex_Ext,Overlap,Dedup rule
    class Validate,Fix success
    class Opt3,Opt4,Opt5,Opt6 pending

    %% æ€§èƒ½æŒ‡æ ‡æ ‡æ³¨
    subgraph Metrics[ä¼˜åŒ–æ•ˆæœç»Ÿè®¡]
        M1[LLMè°ƒç”¨: 5æ¬¡ â†’ 3æ¬¡<br/>â†“ 40%]
        M2[Tokenæ¶ˆè€—: 3000-4000 â†’ 2000-3000<br/>â†“ 33%]
        M3[å¤„ç†é€Ÿåº¦: 10-15ç§’ â†’ 6-10ç§’<br/>â†‘ 1.5-2å€]
        M4[æˆæœ¬: 100% â†’ 60%<br/>â†“ 40%]
        M5[DSLé€»è¾‘: 0% â†’ 95%+<br/>â†‘ 95%+]
    end

    style Metrics fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
